<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <script src="https://kit.fontawesome.com/cc3cb1dbea.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Styling for form layers */
        .signup-form-layer-container{
            width: 100%;
            height: 100%;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; 
        }
        
        #signup-form-role
        {
            display: flex;
        }

        #signup-form-email-password, #signup-form-personal-details, #signup-form-qualification{
            display: none;
        }
        /* Hide form laypers */

        #signup-form-role button{
            margin: 15px 0;
        }
        
    </style>
</head>
<body class="login-signup">
    <article class="login-signup-wrapper">
        <form class="login-signup-form" id="signup-form">

            <!-- Sign Up Role -->
            <section class="signup-form-layer-container" id="signup-form-role">
            
                <h1 class="login-signup-header">Select your Role</h1>

                <!-- Student Role button -->
                <button id="signup-role-student-submit" class="login-signup-buttons btn rounded-pill col-12">Student</button>

                <p class="selection-option">or</p>

                <!-- Educator Role button -->
                <button id="signup-role-educator-submit" class="login-signup-buttons btn rounded-pill col-12">Educator</button>

                <!-- Login link -->
                <div class="login-signup-link">
                    <p>Already have an SPEAR account? <a href="/" id="signup-link">Log In</a></p>
                </div>

            </section>

            <!-- Email and password Input -->
            <section class="signup-form-layer-container" id="signup-form-email-password">
            
                <h1 class="login-signup-header"></h1>

                <!-- Google login -->
                <button id="google-sign-in-btn" class="third-party-login-signup-btn col-12">
                    <div>Signup with Google</div>
                    <img src="../Images/google-icon.png" alt="Google Icon">
                </button>
                
                <!-- Apple login -->
                <button id="apple-sign-in-btn" class="third-party-login-signup-btn col-12">
                    <div>Signup with Apple</div>
                    <img src="../Images/apple-icon.png" alt="Google Icon">
                </button>
                    
                <p class="selection-option">or</p>
                
                <!-- Email input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-email" name="signup-email" class="form-control rounded-pill"
                    placeholder="Enter email">
                    <label for="signup-username">Email</label>
                    <i class="fa-solid fa-user"></i>
                </div>

                <!-- Password input field -->
                <div class="form-floating col-12">
                    <input type="password" id="signup-password" name="signup-password" class="form-control rounded-pill"
                    placeholder="Enter password">
                    <label for="login-password">Password</label>
                    <i class="fa-solid fa-lock"></i>
                </div>

                <!-- Validation Error message -->
                <p class="loginsignup-validation-error" id="signup-email-password-error">Error Message</p>
                
                <!-- signup button -->
                <button type="submit" id="signup-email-password-submit" class="login-signup-buttons btn rounded-pill col-12">Create Account</button>

            </section>

            <!-- Personal Details -->
            <section class="signup-form-layer-container" id="signup-form-personal-details">
            
                <h1 class="login-signup-header">Personal Details</h1>
                <h2 class="login-signup-subheader" id="sign-up-role"></h2>

                <!-- Full Name input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-fullname" name="signup-fullname" class="form-control rounded-pill"
                    placeholder="Enter fullname">
                    <label for="signup-username">Full Name</label>
                    <i class="fa-solid fa-id-badge"></i>
                </div>

                <!-- Contact No input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-contactno" name="signup-contactno" class="form-control rounded-pill"
                    placeholder="Enter contact no">
                    <label for="login-password">Contact No</label>
                    <i class="fa-solid fa-phone-volume"></i>
                </div>

                <!-- Date of Birth input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-dob" name="signup-dob" class="form-control rounded-pill"
                    placeholder="Enter mobile no">
                    <label for="login-password">Date of Birth (dd/MM/yyyy)</label>
                    <i class="fa-solid fa-calendar-days"></i>
                </div>

                <!-- Validation Error message -->
                <p class="loginsignup-validation-error" id="signup-personal-details-error">Error Message</p>
                
                <!-- Continue/Finish button -->
                <button type="submit" id="signup-personal-details-submit" class="login-signup-buttons btn rounded-pill col-12"></button>
                
            </section>

            <!-- Qualification -->
            <section class="signup-form-layer-container" id="signup-form-qualification">
            
                <h1 class="login-signup-header">Qualification</h1>
                <h2 class="login-signup-subheader" id="signup-qualification">Educator</h2>
                
                <!-- Professional Title input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-professional-title" name="signup-professional-title" class="form-control rounded-pill"
                    placeholder="Enter Professional Title">
                    <label for="signup-username">Professional Title</label>
                    <i class="fa-solid fa-user-tie"></i>
                </div>

                <!-- Organisation input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-Organisation" name="signup-Organisation" class="form-control rounded-pill"
                    placeholder="Enter Organisation/Institution">
                    <label for="signup-username">Organisation/Institution</label>
                    <i class="fa-solid fa-building"></i>
                </div>

                <!-- Highest Degree input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-highest-degree" name="signup-highest-degree" class="form-control rounded-pill"
                    placeholder="Enter Highest Degree">
                    <label for="login-password">Highest Degree</label>
                    <i class="fa-solid fa-user-graduate"></i>
                </div>

                <!-- Years of Experience input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-yearsOfExperience" name="signup-yearsOfExperience" class="form-control rounded-pill"
                    placeholder="Enter Years of Experience">
                    <label for="login-password">Years of Experience</label>
                    <i class="fa-solid fa-person-chalkboard"></i>
                </div>

                <!-- Field of Study input field -->
                <div class="form-floating col-12">
                    <input type="text" id="signup-fieldofstudy" name="signup-fieldofstudy" class="form-control rounded-pill"
                    placeholder="Enter Field of Study">
                    <label for="login-password">Field of Study</label>
                    <i class="fa-solid fa-industry"></i>
                </div>

                <!-- Validation Error message -->
                <p class="loginsignup-validation-error" id="signup-qualification-error">Error Message</p>
                
                <!-- Finish button -->
                <button type="submit" id="signup-qualification-submit" class="login-signup-buttons btn rounded-pill col-12">Finish</button>

            </section>
        </form>
    </article>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            sessionStorage.clear();  // Clear session storage

            // Get Form Buttons
            const signupRoleStudentFormButton = document.getElementById("signup-role-student-submit");
            const signupEmailPasswordFormButton = document.getElementById("signup-email-password-submit");
            const signupRoleEducatorFormButton = document.getElementById("signup-role-educator-submit");
            const signupPersonalDetailsFormButton = document.getElementById("signup-personal-details-submit");
            const signupQualificationFormButton = document.getElementById("signup-qualification-submit");

            // Get Form Layers
            const signupEmailPasswordForm = document.getElementById("signup-form-email-password");
            const signupRoleForm = document.getElementById("signup-form-role");
            const signupPersonalDetailsForm = document.getElementById("signup-form-personal-details");
            const signupQualificationForm = document.getElementById("signup-form-qualification");

            let emailPasswordVerified = false;
            let emailPasswordAuthenticated;
            let roleSelected;
            let personalDetailsVerified = false;
            let personalDetailsAuthenticated;
            let qualificationVerified = false;
            let qualificationAuthenticated;

            signupRoleStudentFormButton.addEventListener("click",async function(event){
                event.preventDefault();
                
                roleSelected = "Student";

                signupRoleForm.style.display = "none";  // Hide role form
                signupEmailPasswordForm.style.display = "flex";   // Display personal details form

                document.querySelector("#signup-form-email-password h1").textContent = `Create a ${roleSelected} SPEAR Academy Account`;  // Display role selected
                document.getElementById("sign-up-role").textContent = roleSelected;  // Display role selected
                signupPersonalDetailsFormButton.textContent = "Finish";
            },false);

            signupRoleEducatorFormButton.addEventListener("click",async function(event){
                event.preventDefault();
                
                roleSelected = "Educator";

                signupRoleForm.style.display = "none";  // Hide role form
                signupEmailPasswordForm.style.display = "flex";   // Display personal details form

                document.querySelector("#signup-form-email-password h1").textContent = `Create a ${roleSelected} SPEAR Academy Account`;  // Display role selected
                document.getElementById("sign-up-role").textContent = roleSelected;  // Display role selected
                signupPersonalDetailsFormButton.textContent = "Continue";
            },false);
            
            signupEmailPasswordFormButton.addEventListener("click",async function(event){
                event.preventDefault();

                // Get email and password inputs
                const email = document.getElementById("signup-email").value;
                const password = document.getElementById("signup-password").value;

                let inputFields = document.querySelectorAll("#signup-form #signup-form-email-password .form-floating input");
                let errorMessage = document.getElementById("signup-email-password-error");

                emailPasswordVerified = await validateEmailPassword();
                if (emailPasswordVerified){
                    emailPasswordAuthenticated = await authenticateEmailPassword();
                }
                
                
                if (emailPasswordAuthenticated){
                    signupEmailPasswordForm.style.display = "none"; // Hide email password form
                    signupPersonalDetailsForm.style.display = "flex";      // Display role form
                }

                async function validateEmailPassword(){
                    
                    let errorList = [];

                    inputFields.forEach((inputField) => {
                        if (inputField.classList.contains("error")){
                            inputField.classList.remove("error");   // Remove Red Border
                        }
                        if (inputField.classList.contains("success")){
                            inputField.classList.remove("success");   // Remove Green Border
                        }
                    });

                    // Validate email
                    if (email === "") {
                        
                        inputFields[0].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Email is required");
                    }
                    else if (!email.includes("@") || !email.includes(".")){
                        
                        inputFields[0].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Invalid email format");
                    }
                    else{
                        inputFields[0].classList.add("success");
                    }

                    // Validate password
                    if (password === "") {
                        inputFields[1].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Password is required");
                    }
                    else if (password.length < 4){
                        inputFields[1].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Password must be at least 4 characters long");
                    }
                    else{
                        inputFields[1].classList.add("success");
                    }

                    if (errorList.length === 0){
                        return true;
                    }
                    else{
                        errorMessage.textContent = errorList.join(", ");
                        return false;
                    }
                }
                
                // function to verify email and password of the user by sending a request to the server
                async function authenticateEmailPassword(){

                    const response = await fetch(`/account/signup/createAccount`,{
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password,
                            role: roleSelected
                        })
                    });

                    const data = await response.json();
                    
                    if (response.status === 201){   // If user is created successfully

                        inputFields.forEach((inputField) => {
                            if (inputField.classList.contains("error")){
                                inputField.classList.remove("error");   // Remove Red Border
                            }
                            inputField.classList.add("success");    // Add Green Border
                        });

                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "green";
                        errorMessage.textContent = data.message;
                        console.log(data.message);

                        sessionStorage.setItem("token",data.token);  // Store user object in session storage
                        sessionStorage.setItem("accId",data.accId);
                        /*
                        Accessing Email property of the user object
                        const storedUser = JSON.parse(sessionStorage.getItem("Account"));
                        console.log(storedUser);
                        */
                        
                        return true;
                        
                    }
                    else if (response.status === 406 || response.status === 400) {   // If verfification failed

                        inputFields.forEach((inputField) => {
                            if (inputField.classList.contains("sucess")){
                                inputField.classList.remove("sucess");  // Remove Green Border
                            }
                            inputField.classList.add("error");  // Add Red Border
                        });

                        // Display error message
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        if (data.errors){
                            errorMessage.textContent = data.errors;
                        }
                        else{
                            errorMessage.textContent = data.message;
                        }
                        console.log(errorMessage.textContent);

                        return false;
                        
                    }
                    else if (response.status === 500){
                        alert(data.message);
                        return false;
                    }
                }
            },false);
            
            signupPersonalDetailsFormButton.addEventListener("click",async function(event){
                event.preventDefault();

                const acccId = sessionStorage.getItem("accId");

                // Get personal details inputs
                const fullname = document.getElementById("signup-fullname").value;
                const contactNo = document.getElementById("signup-contactno").value;
                const dob = document.getElementById("signup-dob").value;

                let inputFields = document.querySelectorAll("#signup-form #signup-form-personal-details .form-floating input");
                let errorMessage = document.getElementById("signup-personal-details-error");

                personalDetailsVerified = await validatePersonalDetails();
                if (personalDetailsVerified){
                    personalDetailsAuthenticated = await authenticatePersonalDetails();
                }

                if (personalDetailsAuthenticated){

                    if (roleSelected === "Student"){
                            window.location.href = "../student-pages/student.html";   // Redirect to student home page
                    }
                    else{
                        signupPersonalDetailsForm.style.display = "none";   // Hide personal details form
                        signupQualificationForm.style.display = "flex";   // Display qualification form
                    }
                }

                async function validatePersonalDetails(){
                    let errorList = [];

                    inputFields.forEach((inputField) => {
                        if (inputField.classList.contains("error")){
                            inputField.classList.remove("error");   // Remove Red Border
                        }
                        if (inputField.classList.contains("success")){
                            inputField.classList.remove("success");   // Remove Green Border
                        }
                    });

                    // Validate full name
                    if (fullname === "") {
                        
                        inputFields[0].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Full Name is required");
                    }
                    else{
                        inputFields[0].classList.add("success");
                    }

                    // Validate contact no
                    if (contactNo === "") {
                        inputFields[1].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Contact No is required");
                    }
                    else if (contactNo.length < 10){
                        inputFields[1].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Contact No must be at least 10 characters long");
                    }
                    else{
                        inputFields[1].classList.add("success");
                    }

                    // Validate date of birth
                    const pattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                    if (dob === "") {
                        inputFields[2].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Date of Birth is required");
                    }
                    else if (pattern.test(dob) === false){
                        inputFields[2].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Invalid Date of Birth format");
                    }
                    else{
                        inputFields[2].classList.add("success");
                    }

                    if (errorList.length === 0){
                        return true;
                    }
                    else{
                        errorMessage.textContent = errorList.join(", ");
                        return false;
                    }
                }
                
                // function to authenticate personal details of the user by sending a request to the server
                async function authenticatePersonalDetails(){

                    const response = await fetch(`/account/update/updatePersonalDetails/${acccId}`,{
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${sessionStorage.getItem("token")}` // Include JWT token in the Authorization header
                        },
                        body: JSON.stringify({
                            fullName: fullname,
                            contactNo: contactNo,
                            dob: dob,
                        })
                    });

                    const data = await response.json(); // Convert response to JSON

                    if (response.status === 201){   // If user is created successfully

                        inputFields.forEach((inputField) => {
                            if (inputField.classList.contains("error")){
                                inputField.classList.remove("error");   // Remove Red Border
                            }
                            inputField.classList.add("success");    // Add Green Border
                        });

                        // Display success message
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "green";
                        errorMessage.textContent = "Authenticated successfully";
                        console.log("Personal Details validated successfully");

                        return true;

                    }
                    else if (response.status === 400 || response.status === 404){    // If verification failed

                        inputFields.forEach((inputField) => {
                            if (inputField.classList.contains("sucess")){
                                inputField.classList.remove("sucess");  // Remove Green Border
                            }
                            inputField.classList.add("error");  // Add Red Border
                        });

                        // Display error message
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        if (data.errors){
                            errorMessage.textContent = data.errors;
                        }
                        else{
                            errorMessage.textContent = data.message;
                        }
                        console.log(errorMessage.textContent);

                        return false;

                    }
                    else if (response.status === 500){   // If server error
                        alert(data.message);
                        return false;
                    }
                }
            },false);

            signupQualificationFormButton.addEventListener("click",async function(event){
                event.preventDefault();

                const eduId = sessionStorage.getItem("accId");

                // Get qualification inputs
                const professionalTitle = document.getElementById("signup-professional-title").value;
                const organisation = document.getElementById("signup-Organisation").value;
                const highestDegree = document.getElementById("signup-highest-degree").value;
                const yearsOfExperience = document.getElementById("signup-yearsOfExperience").value;
                const fieldOfStudy = document.getElementById("signup-fieldofstudy").value;

                let inputFields = document.querySelectorAll("#signup-form #signup-form-qualification .form-floating input");
                let errorMessage = document.getElementById("signup-qualification-error");

                qualificationVerified = await validatePersonalDetails();

                if (qualificationVerified){
                    qualificationAuthenticated = await verifyQualification();
                }

                if (qualificationAuthenticated){
                    window.location.href = "../educator-pages/creator.html";   // Redirect to educator home page
                }

                async function validatePersonalDetails(){
                    let errorList = [];

                    inputFields.forEach((inputField) => {
                        if (inputField.classList.contains("error")){
                            inputField.classList.remove("error");   // Remove Red Border
                        }
                        if (inputField.classList.contains("success")){
                            inputField.classList.remove("success");   // Remove Green Border
                        }
                    });

                    // Validate professional title
                    if (professionalTitle === "") {
                        
                        inputFields[0].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Professional Title is required");
                    }
                    else{
                        inputFields[0].classList.add("success");
                    }

                    // Validate organisation
                    if (organisation === "") {
                        inputFields[1].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Organisation is required");
                    }
                    else{
                        inputFields[1].classList.add("success");
                    }

                    // Validate highest degree
                    if (highestDegree === "") {
                        inputFields[2].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Highest Degree is required");
                    }
                    else{
                        inputFields[2].classList.add("success");
                    }

                    const pattern = /^[0-9]+$/;
                    // Validate years of experience
                    if (yearsOfExperience === "") {
                        inputFields[3].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Years of Experience is required");
                    }
                    else if (yearsOfExperience < 0 || pattern.test(yearsOfExperience) === false){
                        inputFields[3].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Years of Experience is invalid");
                    }
                    else{
                        inputFields[3].classList.add("success");
                    }

                    // Validate field of study
                    if (fieldOfStudy === "") {
                        inputFields[4].classList.add("error");
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        errorList.push("Field of Study is required");
                    }
                    else{
                        inputFields[4].classList.add("success");
                    }


                    if (errorList.length === 0){
                        return true;
                    }
                    else{
                        errorMessage.textContent = errorList.join(", ");
                        return false;
                    }
                }

                // function to verify qualification of the user by sending a request to the server
                async function verifyQualification(){

                    const response = await fetch(`/educator/createEducator/${eduId}`,{
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${sessionStorage.getItem("token")}` // Include JWT token in the Authorization header
                        },
                        body: JSON.stringify({
                            professionalTitle: professionalTitle,
                            organisation: organisation,
                            highestDegree: highestDegree,
                            yearsOfExperience: yearsOfExperience,
                            fieldOfStudy: fieldOfStudy
                        })
                    });

                    const data = await response.json();

                    if (response.status === 201){   // If user is created successfully

                        inputFields.forEach((inputField) => {
                            if (inputField.classList.contains("error")){
                                inputField.classList.remove("error");   // Remove Red Border
                            }
                            inputField.classList.add("success");    // Add Green Border
                        });

                        // Display success message
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "green";
                        errorMessage.textContent = "Authenticated successfully";
                        console.log("Qualification validated successfully");

                        return true;

                    }
                    else if (response.status === 400 || response.status === 404){    // If verification failed

                        inputFields.forEach((inputField) => {
                            if (inputField.classList.contains("sucess")){
                                inputField.classList.remove("sucess");
                            }
                            inputField.classList.add("error");
                        });

                        // Display error message
                        errorMessage.style.visibility = "visible";
                        errorMessage.style.color = "red";
                        if (data.errors){
                            errorMessage.textContent = data.errors;
                        }
                        else{
                            errorMessage.textContent = data.message;
                        }
                        console.log(errorMessage.textContent);

                        return false;
                    }
                    else if (response.status === 500){   // If server error
                        alert(data.message);
                        return false;
                    }
                }
            },false);
        });
    </script>
</body>
</html>